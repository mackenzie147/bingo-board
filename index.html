<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        .bingo-item {
            aspect-ratio: 1 / 1;
            transition: all 0.2s ease-in-out;
            cursor: grab;
            position: relative;
        }
        .bingo-item:active {
             cursor: grabbing;
        }
        .bingo-item.status-inprogress {
            background-color: #FEF9C3; /* yellow-100 */
            border-color: #FDE047; /* yellow-400 */
            transform: scale(1.03);
        }
        .bingo-item.status-completed {
            background-color: #D1FAE5; /* green-100 */
            border-color: #34D399; /* green-400 */
            transform: scale(1.03);
        }
        .bingo-item.status-completed .item-text {
            text-decoration: line-through;
            opacity: 0.7;
        }
        .item-text[contenteditable="true"] {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
            border-radius: 4px;
            cursor: text;
        }
        .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s ease;
        }
        .bingo-item:hover .delete-btn {
            opacity: 1;
            transform: scale(1);
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #c8ebfb;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <div class="flex items-center justify-center gap-2">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Bingo Board</h1>
                 <input type="number" id="year-selector" value="2025" class="w-24 p-1 text-4xl md:text-5xl font-bold bg-transparent text-center focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
            </div>
            <p id="subheading" class="text-gray-500 mt-2">Drag to reorder, double-click to edit, click to update status.</p>
        </header>

        <div id="auth-loading" class="text-center py-10">
            <p>Connecting to your board...</p>
        </div>
        
        <div id="auth-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
            <strong class="font-bold">Project Not Configured!</strong>
            <span class="block sm:inline">Please check the browser console for more details. This usually means the Firebase configuration is missing or incorrect in the HTML file.</span>
        </div>

        <main id="app-content" class="hidden">
            <!-- Add Item Form -->
            <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-item-input" placeholder="Add a new bingo item..." class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="add-item-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors w-full sm:w-auto">Add Item</button>
                </div>
            </div>

            <!-- Bingo Grid -->
            <div id="bingo-grid" class="bingo-grid">
                <!-- Bingo items will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, query, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB8q-jT15zfaiiqHDyeoZl_Ccz5tQMTzk4",
          authDomain: "bingo-project-e9e10.firebaseapp.com",
          projectId: "bingo-project-e9e10",
          storageBucket: "bingo-project-e9e10.appspot.com",
          messagingSenderId: "995103961297",
          appId: "1:995103961297:web:e5f07ed199e02bc4ee95f0",
          measurementId: "G-KL097JXKRC"
        };

        // -- App State --
        let db, auth, userId, itemsUnsubscribe;
        let currentYear = 2025;
        const items = new Map();

        // -- DOM Elements --
        const authLoadingEl = document.getElementById('auth-loading');
        const authErrorEl = document.getElementById('auth-error');
        const appContentEl = document.getElementById('app-content');
        const newItemInput = document.getElementById('new-item-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const bingoGrid = document.getElementById('bingo-grid');
        const yearSelector = document.getElementById('year-selector');

        // -- Firebase Initialization --
        function initializeFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Firebase config is missing.");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                handleAuthentication();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showAuthError();
            }
        }
        
        function handleAuthentication() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    authLoadingEl.classList.add('hidden');
                    appContentEl.classList.remove('hidden');
                    initializeSortable();
                    listenForItems();
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        showAuthError();
                    });
                }
            });
        }
        
        function showAuthError() {
            authLoadingEl.classList.add('hidden');
            authErrorEl.classList.remove('hidden');
        }

        // -- Firestore Functions --
        function listenForItems() {
            if (itemsUnsubscribe) itemsUnsubscribe();
            
            items.clear();
            bingoGrid.innerHTML = '';
            
            const itemsRef = collection(db, 'bingoBoards', String(currentYear), 'items');
            const q = query(itemsRef);

            itemsUnsubscribe = onSnapshot(q, (snapshot) => {
                let shouldRenderAll = false;
                snapshot.docChanges().forEach((change) => {
                    const docData = change.doc.data();
                    const docId = change.doc.id;

                    if (change.type === "added") {
                        items.set(docId, { id: docId, ...docData });
                        shouldRenderAll = true; 
                    }
                    if (change.type === "modified") {
                        const oldData = items.get(docId);
                        items.set(docId, { id: docId, ...docData });
                        if(oldData && oldData.order !== docData.order) {
                            shouldRenderAll = true; // Re-render if order changes
                        } else {
                            updateItemInDOM(docId, docData);
                        }
                    }
                    if (change.type === "removed") {
                        items.delete(docId);
                        removeItemFromDOM(docId);
                    }
                });
                
                if (shouldRenderAll) {
                    renderAllItems();
                }

            }, (error) => {
                console.error(`Error listening to items for year ${currentYear}:`, error);
            });
        }
        
        async function addNewItem() {
            const text = newItemInput.value.trim();
            if (text === '') return;
            
            try {
                const itemsRef = collection(db, 'bingoBoards', String(currentYear), 'items');
                await addDoc(itemsRef, {
                    text: text,
                    status: 'normal',
                    order: items.size, // Set order to the current number of items
                    createdAt: serverTimestamp()
                });
                newItemInput.value = '';
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        }

        async function updateItem(id, data) {
            try {
                const itemRef = doc(db, 'bingoBoards', String(currentYear), 'items', id);
                await updateDoc(itemRef, data);
            } catch (error) {
                console.error("Error updating item:", error);
            }
        }
        
        async function deleteItem(id) {
             try {
                const itemRef = doc(db, 'bingoBoards', String(currentYear), 'items', id);
                await deleteDoc(itemRef);
            } catch (error) {
                console.error("Error deleting item:", error);
            }
        }

        async function updateItemsOrder() {
            const batch = writeBatch(db);
            const itemElements = Array.from(bingoGrid.children);
            
            itemElements.forEach((el, index) => {
                const id = el.dataset.id;
                if (id) {
                    const itemRef = doc(db, 'bingoBoards', String(currentYear), 'items', id);
                    batch.update(itemRef, { order: index });
                }
            });

            try {
                await batch.commit();
            } catch (error) {
                console.error("Error updating order:", error);
            }
        }

        // -- DOM Manipulation & Rendering --
        function renderAllItems() {
            bingoGrid.innerHTML = ''; // Clear the grid
            const sortedItems = Array.from(items.values()).sort((a, b) => (a.order || 0) - (b.order || 0));
            sortedItems.forEach(item => {
                const itemEl = createItemElement(item.id, item);
                bingoGrid.appendChild(itemEl);
            });
        }

        function createItemElement(id, data) {
            const itemEl = document.createElement('div');
            itemEl.id = `item-${id}`;
            itemEl.dataset.id = id;
            itemEl.className = 'bingo-item flex items-center justify-center p-3 border-2 border-gray-300 bg-white rounded-lg shadow-sm text-center';
            
            const textEl = document.createElement('p');
            textEl.className = 'item-text text-sm font-medium';
            textEl.textContent = data.text;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg text-gray-500 hover:text-red-500" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>`;
            deleteBtn.onclick = (e) => {
                e.stopPropagation(); // Prevent status change click
                if (confirm('Are you sure you want to delete this item?')) {
                    deleteItem(id);
                }
            };

            itemEl.appendChild(textEl);
            itemEl.appendChild(deleteBtn);

            updateItemStyles(itemEl, data);
            return itemEl;
        }
        
        function updateItemInDOM(id, data) {
            const itemEl = document.getElementById(`item-${id}`);
            if (!itemEl) return;
            
            updateItemStyles(itemEl, data);
            
            const textEl = itemEl.querySelector('.item-text');
            if (textEl && textEl.textContent !== data.text) {
                 textEl.textContent = data.text;
            }
        }

        function updateItemStyles(element, data) {
            element.className = 'bingo-item flex items-center justify-center p-3 border-2 border-gray-300 bg-white rounded-lg shadow-sm text-center'; // Reset classes
            if (data.status === 'inprogress') {
                element.classList.add('status-inprogress');
            } else if (data.status === 'completed') {
                element.classList.add('status-completed');
            }
        }
        
        function removeItemFromDOM(id) {
            const itemEl = document.getElementById(`item-${id}`);
            if (itemEl) itemEl.remove();
        }

        // -- Drag and Drop --
        function initializeSortable() {
            new Sortable(bingoGrid, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: () => {
                    updateItemsOrder();
                }
            });
        }
        
        // -- Event Listeners --
        addItemBtn.addEventListener('click', addNewItem);
        newItemInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') addNewItem();
        });

        yearSelector.addEventListener('change', () => {
            const year = parseInt(yearSelector.value);
            if (!isNaN(year) && year > 1900 && year < 3000 && year !== currentYear) {
                currentYear = year;
                listenForItems();
            }
        });

        bingoGrid.addEventListener('click', (e) => {
            const itemEl = e.target.closest('.bingo-item');
            if (!itemEl) return;

            // Prevent clicks on the delete button or editable text from triggering status change
            if (e.target.closest('.delete-btn') || itemEl.querySelector('.item-text[contenteditable="true"]')) return;

            const id = itemEl.dataset.id;
            const currentItem = items.get(id);
            if (!currentItem) return;
            
            let newStatus;
            if (currentItem.status === 'normal') newStatus = 'inprogress';
            else if (currentItem.status === 'inprogress') newStatus = 'completed';
            else newStatus = 'normal';
            
            updateItem(id, { status: newStatus });
        });

        bingoGrid.addEventListener('dblclick', (e) => {
            const textEl = e.target.closest('.item-text');
            if (!textEl) return;
            
            const itemEl = textEl.closest('.bingo-item');
            const id = itemEl.dataset.id;
            
            textEl.setAttribute('contenteditable', 'true');
            textEl.focus();
            
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(textEl);
            selection.removeAllRanges();
            selection.addRange(range);

            const onBlur = () => {
                textEl.setAttribute('contenteditable', 'false');
                const newText = textEl.textContent.trim();
                
                if (newText === '') {
                    deleteItem(id);
                } else {
                    const currentItem = items.get(id);
                    if (currentItem && currentItem.text !== newText) {
                         updateItem(id, { text: newText });
                    }
                }
                textEl.removeEventListener('blur', onBlur);
                textEl.removeEventListener('keydown', onKeydown);
            };
            
            const onKeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    textEl.blur();
                } else if (e.key === 'Escape') {
                    const currentItem = items.get(id);
                    textEl.textContent = currentItem ? currentItem.text : '';
                    textEl.blur();
                }
            };

            textEl.addEventListener('blur', onBlur);
            textEl.addEventListener('keydown', onKeydown);
        });

        // -- App Start --
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .bingo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        .bingo-item { aspect-ratio: 1 / 1; transition: all 0.2s ease-in-out; cursor: grab; position: relative; }
        .bingo-item.status-inprogress { background-color: #FEF9C3; border-color: #FDE047; transform: scale(1.03); }
        .bingo-item.status-completed { background-color: #D1FAE5; border-color: #34D399; transform: scale(1.03); }
        .bingo-item.status-completed .item-text { text-decoration: line-through; opacity: 0.7; }
        .delete-btn { position: absolute; top: -8px; right: -8px; background-color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e7eb; cursor: pointer; opacity: 0; transition: all 0.2s ease; }
        .bingo-item:hover .delete-btn { opacity: 1; }
        .tab-button { transition: all 0.2s; border-bottom: 3px solid transparent; }
        .tab-button.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 700; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6">Bingo Board</h1>
            
            <div class="flex justify-center gap-8 border-b border-gray-200 mb-8">
                <button onclick="switchYear(2025)" id="tab-2025" class="tab-button pb-2 px-4 text-gray-500 hover:text-blue-500">2025 Archive</button>
                <button onclick="switchYear(2026)" id="tab-2026" class="tab-button pb-2 px-4 text-gray-500 hover:text-blue-500 active">2026 Goals</button>
            </div>
            
            <p id="subheading" class="text-gray-500">Drag to reorder, double-click to edit, click to update status.</p>
        </header>

        <div id="auth-loading" class="text-center py-10">
            <p>Connecting to your board...</p>
        </div>
        
        <div id="auth-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
            <strong class="font-bold">Project Not Configured!</strong>
        </div>

        <main id="app-content" class="hidden">
            <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-item-input" placeholder="Add a new bingo item..." class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                    <button id="add-item-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-md transition-colors">Add</button>
                </div>
            </div>

            <div id="bingo-grid" class="bingo-grid"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, query, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB8q-jT15zfaiiqHDyeoZl_Ccz5tQMTzk4",
          authDomain: "bingo-project-e9e10.firebaseapp.com",
          projectId: "bingo-project-e9e10",
          storageBucket: "bingo-project-e9e10.appspot.com",
          messagingSenderId: "995103961297",
          appId: "1:995103961297:web:e5f07ed199e02bc4ee95f0",
          measurementId: "G-KL097JXKRC"
        };

        let db, auth, userId, itemsUnsubscribe;
        let currentYear = 2026; // Default to the new year
        const items = new Map();

        const authLoadingEl = document.getElementById('auth-loading');
        const appContentEl = document.getElementById('app-content');
        const bingoGrid = document.getElementById('bingo-grid');
        const newItemInput = document.getElementById('new-item-input');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Global function for the tabs
        window.switchYear = (year) => {
            if (year === currentYear) return;
            currentYear = year;
            
            // Update UI Tabs
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${year}`).classList.add('active');
            
            listenForItems();
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                authLoadingEl.classList.add('hidden');
                appContentEl.classList.remove('hidden');
                initializeSortable();
                listenForItems();
            } else {
                signInAnonymously(auth);
            }
        });

        function listenForItems() {
            if (itemsUnsubscribe) itemsUnsubscribe();
            items.clear();
            bingoGrid.innerHTML = '';
            
            const itemsRef = collection(db, 'bingoBoards', String(currentYear), 'items');
            itemsUnsubscribe = onSnapshot(query(itemsRef), (snapshot) => {
                let shouldRenderAll = false;
                snapshot.docChanges().forEach((change) => {
                    const docData = change.doc.data();
                    const docId = change.doc.id;
                    if (change.type === "added") { items.set(docId, { id: docId, ...docData }); shouldRenderAll = true; }
                    if (change.type === "modified") {
                        const old = items.get(docId);
                        items.set(docId, { id: docId, ...docData });
                        if(old?.order !== docData.order) shouldRenderAll = true;
                        else updateItemInDOM(docId, docData);
                    }
                    if (change.type === "removed") { items.delete(docId); removeItemFromDOM(docId); }
                });
                if (shouldRenderAll) renderAllItems();
            });
        }

        async function addNewItem() {
            const text = newItemInput.value.trim();
            if (!text) return;
            await addDoc(collection(db, 'bingoBoards', String(currentYear), 'items'), {
                text: text, status: 'normal', order: items.size, createdAt: serverTimestamp()
            });
            newItemInput.value = '';
        }

        function renderAllItems() {
            bingoGrid.innerHTML = '';
            [...items.values()].sort((a, b) => (a.order || 0) - (b.order || 0)).forEach(item => {
                bingoGrid.appendChild(createItemElement(item.id, item));
            });
        }

        function createItemElement(id, data) {
            const el = document.createElement('div');
            el.id = `item-${id}`;
            el.dataset.id = id;
            el.className = 'bingo-item flex items-center justify-center p-3 border-2 border-gray-300 bg-white rounded-lg shadow-sm text-center font-medium text-sm';
            el.innerHTML = `<p class="item-text">${data.text}</p><button class="delete-btn"><svg width="14" height="14" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg></button>`;
            
            el.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); if(confirm('Delete?')) deleteDoc(doc(db, 'bingoBoards', String(currentYear), 'items', id)); };
            updateItemStyles(el, data);
            return el;
        }

        function updateItemStyles(el, data) {
            el.classList.remove('status-inprogress', 'status-completed');
            if (data.status === 'inprogress') el.classList.add('status-inprogress');
            if (data.status === 'completed') el.classList.add('status-completed');
        }

        function updateItemInDOM(id, data) {
            const el = document.getElementById(`item-${id}`);
            if (el) { updateItemStyles(el, data); el.querySelector('.item-text').textContent = data.text; }
        }

        function removeItemFromDOM(id) { document.getElementById(`item-${id}`)?.remove(); }

        function initializeSortable() {
            new Sortable(bingoGrid, { animation: 150, onEnd: async () => {
                const batch = writeBatch(db);
                Array.from(bingoGrid.children).forEach((el, i) => {
                    batch.update(doc(db, 'bingoBoards', String(currentYear), 'items', el.dataset.id), { order: i });
                });
                await batch.commit();
            }});
        }

        document.getElementById('add-item-btn').onclick = addNewItem;
        newItemInput.onkeydown = (e) => { if(e.key === 'Enter') addNewItem(); };
        bingoGrid.onclick = (e) => {
            const el = e.target.closest('.bingo-item');
            if (!el || e.target.closest('.delete-btn')) return;
            const item = items.get(el.dataset.id);
            const next = item.status === 'normal' ? 'inprogress' : item.status === 'inprogress' ? 'completed' : 'normal';
            updateDoc(doc(db, 'bingoBoards', String(currentYear), 'items', el.dataset.id), { status: next });
        };
        
        bingoGrid.ondblclick = (e) => {
            const textEl = e.target.closest('.item-text');
            if (!textEl) return;
            textEl.contentEditable = true;
            textEl.focus();
            textEl.onblur = () => {
                textEl.contentEditable = false;
                updateDoc(doc(db, 'bingoBoards', String(currentYear), 'items', textEl.closest('.bingo-item').dataset.id), { text: textEl.textContent });
            };
        };
    </script>
</body>
</html>
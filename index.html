<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900 text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Bingo Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bingo-cell {
            transition: all 0.3s ease-in-out;
            word-wrap: break-word;
        }
        .status-default {
            background-color: #374151; /* gray-700 */
        }
        .status-in-progress {
            background-color: #f59e0b; /* amber-500 */
            color: #1f2937; /* gray-800 */
            transform: scale(1.02);
        }
        .status-completed {
            background-color: #22c55e; /* green-500 */
            color: #1f2937; /* gray-800 */
            text-decoration: line-through;
            transform: scale(1.02);
        }
        .bingo-cell.editing {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
        }
    </style>
</head>
<body class="h-full flex items-center justify-center p-4 bg-gray-900">
    <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 z-50">
        <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <main class="w-full max-w-7xl mx-auto p-6 md:p-8 bg-gray-800 rounded-2xl shadow-2xl">
        <div class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-white">My <span id="current-year"></span> Bingo</h1>
            <p class="text-gray-400 mt-2">Click a square to cycle its status. Double-click to edit.</p>
        </div>

        <!-- Controls -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <input type="text" id="newItemInput" placeholder="Add a new bingo item..." class="flex-grow bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="addItemBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-lg transition-colors duration-300">Add Item</button>
        </div>
        
        <!-- Bingo Grid -->
        <div id="bingo-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4">
            <!-- Cells will be generated by JavaScript -->
        </div>

        <!-- User ID Display -->
        <div class="text-center mt-6">
             <p class="text-xs text-gray-500">User ID: <span id="userIdDisplay" class="font-mono"></span></p>
        </div>
    </main>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-bingo-app';
        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        } catch (e) {
            console.error("Failed to parse Firebase config:", e);
            firebaseConfig = null;
        }

        let app, db, auth, userId;
        let bingoDocRef;
        let localBingoState = { items: [] };
        
        const yearSpan = document.getElementById('current-year');
        const grid = document.getElementById('bingo-grid');
        const newItemInput = document.getElementById('newItemInput');
        const addItemBtn = document.getElementById('addItemBtn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const userIdDisplay = document.getElementById('userIdDisplay');
        
        yearSpan.textContent = new Date().getFullYear();

        // --- Core Functions ---
        
        const renderBingoBoard = () => {
            grid.innerHTML = '';
            if (!localBingoState || !localBingoState.items) {
                console.warn("Bingo state or items are undefined. Cannot render board.");
                return;
            };

            localBingoState.items.forEach((item, index) => {
                const cell = document.createElement('div');
                cell.className = `bingo-cell flex items-center justify-center p-3 md:p-4 aspect-square rounded-lg cursor-pointer text-center font-medium shadow status-${item.status}`;
                cell.dataset.index = index;
                
                const textSpan = document.createElement('span');
                textSpan.textContent = item.text;
                cell.appendChild(textSpan);

                // --- Event Listeners for Cell ---
                let clickTimeout = null;
                
                cell.addEventListener('click', () => {
                    if (clickTimeout) {
                        clearTimeout(clickTimeout);
                        clickTimeout = null;
                        handleDoubleClick(index);
                    } else {
                        clickTimeout = setTimeout(() => {
                           handleClick(index);
                           clickTimeout = null;
                        }, 250); // 250ms delay to distinguish single from double click
                    }
                });
                
                grid.appendChild(cell);
            });
        };
        
        const handleClick = (index) => {
            const statuses = ['default', 'in-progress', 'completed'];
            const currentStatus = localBingoState.items[index].status;
            const nextIndex = (statuses.indexOf(currentStatus) + 1) % statuses.length;
            localBingoState.items[index].status = statuses[nextIndex];
            updateFirestoreState();
        };
        
        const handleDoubleClick = (index) => {
            const cell = grid.querySelector(`[data-index='${index}']`);
            const textSpan = cell.querySelector('span');
            const currentText = localBingoState.items[index].text;

            const input = document.createElement('textarea');
            input.value = currentText;
            input.className = "absolute inset-0 w-full h-full bg-gray-600 text-white p-2 rounded-lg resize-none text-center focus:outline-none";
            cell.classList.add('editing');
            
            cell.replaceChild(input, textSpan);
            input.focus();
            input.select();

            const saveChanges = () => {
                const newText = input.value.trim();
                if (newText && newText !== currentText) {
                    localBingoState.items[index].text = newText;
                    updateFirestoreState();
                }
                // If the text is empty, delete the item
                else if (!newText) {
                    localBingoState.items.splice(index, 1);
                    updateFirestoreState();
                }
                // If no changes, just re-render to restore span
                else {
                   renderBingoBoard();
                }
                 cell.classList.remove('editing');
            };

            input.addEventListener('blur', saveChanges);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    input.blur();
                }
                if (e.key === 'Escape') {
                    input.value = currentText; // revert changes
                    input.blur();
                }
            });
        };

        const handleAddItem = async () => {
            const text = newItemInput.value.trim();
            if (text) {
                const newItem = {
                    text: text,
                    status: 'default',
                    createdAt: new Date().toISOString()
                };
                if (!localBingoState.items) {
                   localBingoState.items = [];
                }
                localBingoState.items.push(newItem);
                newItemInput.value = '';
                await updateFirestoreState();
                // Rerender is handled by onSnapshot, but we can call it for faster UI feedback
                renderBingoBoard(); 
            }
        };

        const updateFirestoreState = async () => {
            if (bingoDocRef) {
                try {
                    await setDoc(bingoDocRef, localBingoState, { merge: true });
                } catch (error) {
                    console.error("Error updating Firestore:", error);
                }
            }
        };

        // --- Initialization ---

        const initialize = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is not available.");
                loadingSpinner.style.display = 'none';
                grid.innerHTML = `<p class="text-red-400 col-span-full">Application is not configured correctly. Please check console.</p>`;
                return;
            }
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    
                    // Path for user's private data
                    const docPath = `/artifacts/${appId}/users/${userId}/bingo_boards/main`;
                    bingoDocRef = doc(db, docPath);

                    onSnapshot(bingoDocRef, (doc) => {
                        loadingSpinner.style.display = 'none';
                        if (doc.exists()) {
                            localBingoState = doc.data();
                            // Ensure items array exists
                            if (!localBingoState.items) {
                                localBingoState.items = [];
                            }
                        } else {
                            // First time user, create an empty board
                            localBingoState = { items: [] };
                            setDoc(bingoDocRef, localBingoState);
                        }
                        renderBingoBoard();
                    }, (error) => {
                        console.error("Error with Firestore snapshot:", error);
                        loadingSpinner.style.display = 'none';
                        grid.innerHTML = `<p class="text-red-400 col-span-full">Error loading data. Please refresh.</p>`;
                    });

                } else {
                    console.log("No user is signed in.");
                    loadingSpinner.style.display = 'none';
                }
            });

            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                loadingSpinner.style.display = 'none';
                grid.innerHTML = `<p class="text-red-400 col-span-full">Could not authenticate. Please refresh.</p>`;
            }
        };

        // --- Event Listeners for Controls ---
        addItemBtn.addEventListener('click', handleAddItem);
        newItemInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleAddItem();
            }
        });

        // Start the application
        initialize();
    </script>
</body>
</html>
